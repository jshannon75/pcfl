---
title: 'PCFL: Week 3 wrap-up'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = "C:/Users/jshannon/Dropbox/Jschool/Other/pcfl2020")
library(httr)
library(tidyverse)
library(lubridate)
library(knitr)

#ReadData
year<-2020
league<-1403922

url_match<-paste("https://fantasy.espn.com/apis/v3/games/ffl/seasons/",
          year,"/segments/0/leagues/",league,"?view=mMatchup",sep="")
match_raw<-GET(url_match)

MatchRaw <- rawToChar(match_raw$content)
Match <- jsonlite::fromJSON(MatchRaw)

# url_teams<-paste("https://fantasy.espn.com/apis/v3/games/ffl/seasons/",
#             year,"/segments/0/leagues/",league,sep="")
# teams_raw<-GET(url_teams)
# TeamsRaw <- rawToChar(teams_raw$content)
# Teams <- jsonlite::fromJSON(TeamsRaw)

url_standing<-paste("https://fantasy.espn.com/apis/v3/games/ffl/seasons/",
          year,"/segments/0/leagues/",league,"?view=mStandings",sep="")
standing_raw<-GET(url_match)

StandingRaw <- rawToChar(standing_raw$content)
standings <- jsonlite::fromJSON(StandingRaw)

url_standing<-paste("https://fantasy.espn.com/apis/v3/games/ffl/seasons/",
          year,"/segments/0/leagues/",league,"?view=mSchedule",sep="")
standing_raw<-GET(url_match)

StandingRaw <- rawToChar(standing_raw$content)
standings <- jsonlite::fromJSON(StandingRaw)

# schedule<-tibble(
#   week=Match$schedule$matchupPeriodId,
#   away_id=Match$schedule$away$teamId,
#   home_id=Match$schedule$home$teamId
# )
# write_csv(schedule,"data/league_schedule.csv")

schedule<-read_csv("data/league_schedule.csv")

# 
# team_list<-Teams$teams %>%
#   mutate(teamid=row_number(),
#          fullname=paste(location,nickname))
# write_csv(team_list %>%
#             select(-owners),"league_roster.csv")
team_list<-read_csv("data/league_roster.csv")

away<-standings$schedule$away %>%
  filter(totalPoints>0) %>%
  select(-gamesPlayed) %>%
  rename(awayteam=teamId,awaypoints=totalPoints)
home<-standings$schedule$home %>%
  filter(totalPoints>0) %>%
  select(-gamesPlayed) %>%
  rename(hometeam=teamId,homepoints=totalPoints)
results<-bind_cols(away,home) %>%
  mutate(away_result=if_else(awaypoints>homepoints,"W","L"),
         home_result=if_else(homepoints>awaypoints,"W","L"),
         week=ceiling(row_number()/5))

#Create standings
names<-c("teamId","points_scored","points_allowed","result","week")
away_sel<-results %>%
  select(awayteam,awaypoints,homepoints,away_result,week)
names(away_sel)<-names

home_sel<-results %>%
  select(hometeam,homepoints,awaypoints,home_result,week)
names(home_sel)<-names

stand_tbl1<-bind_rows(away_sel,home_sel) %>%
  group_by(teamId) %>%
  summarise(points_scored=sum(points_scored),
            points_allowed=sum(points_allowed))
stand_tbl<-bind_rows(away_sel,home_sel) %>%
  count(teamId,result) %>% 
  left_join(team_list %>% select(teamId,fullname,division)) %>%
  pivot_wider(names_from=result,
              values_from=n,
              values_fill=0) %>%
  left_join(stand_tbl1) %>%
  select(fullname,division,W,L,points_scored,points_allowed) %>%
  arrange(-points_scored) %>%
  mutate(points_rank=1:n()) %>%
  arrange(-W,-points_scored) %>% 
  mutate(playoff_rank = 1:n())


#Last week's games
player_extract<-function(team_slot){
  df<-Match$teams$roster$entries[[team_slot]]
  add_date<-as.Date(as.POSIXct(df$acquisitionDate/1000, origin="1970-01-01"))
  name<-df$playerPoolEntry$player$fullName
  points<-df$playerPoolEntry$appliedStatTotal
  slot<-df$lineupSlotId
  
  tibble(add_date,name,points,slot) %>%
    mutate(bench=if_else(slot<20,0,1),
           rowid=team_slot)
}
players<-map_df(1:10,player_extract) %>%
  left_join(team_list)
#write_csv(players,"data/players_wk3.csv")

benchpoints<-players %>%
  group_by(abbrev,bench) %>%
  summarise(points=sum(points)) %>%
  filter(bench==1) %>%
  left_join(team_list) %>%
  ungroup() %>%
  select(fullname,points)

recent_adds<-players %>%
  mutate(stay=time_length(interval(start=add_date,end=today()),"day")) %>%
  filter(stay<7)

nextweek_long<-schedule %>%
  filter(week==4) %>%
  mutate(gameid=row_number()) %>%
  pivot_longer(away_id:home_id,
               names_to="awayhome",
               values_to="teamId") %>%
  left_join(team_list %>% 
              select(teamId,fullname)) %>%
  left_join(stand_tbl %>%
              select(fullname,points_scored)) %>%
  select(-teamId) 
  
nextweek<-nextweek_long %>%
  filter(awayhome=="away_id") %>%
  rename(away_team=fullname,
         away_points=points_scored) %>%
  left_join(nextweek_long %>%
              filter(awayhome=="home_id") %>%
              select(-awayhome) %>%
              rename(home_team=fullname,
                     home_points=points_scored)) %>%
  mutate(range=abs(away_points-home_points)) %>%
  select(-gameid,-awayhome) 

```

Text about the week.

### League standings and season stats
Here's a look at our current standings

```{r, echo=FALSE}
kable(stand_tbl)
```

Here's our current awards leaders from these standings:

* Yellow shirt (most points): 
* D-FENCE (least points allowed): 
* Tough luck (points rank - playoff rank):
* First round bye (playoff rank - points rank):

Here's a list of the **top five scoring performances** so far this season.

```{r, include=FALSE}
toppoints<-bind_rows(away_sel,home_sel) %>%
  left_join(team_list) %>%
  select(fullname,week,points_scored,result) %>%
  top_n(5,points_scored) %>%
  arrange(-points_scored) 
```
```{r, echo=FALSE}
kable(toppoints)
```

Erin and Trav retain the top spot here, a good 30 points over Jacob's G.O.A.T.

### Last week's games

Here's last week's **10 best performing players.** The bench variable shows whether they got left on the bench or not.

```{r,echo=FALSE}
kable(top_n(players %>% 
              select(name,points,fullname,bench),10,points) %>%
        arrange(-points))
```

There were `r nrow(recent_adds)` players added last week. Which was the **best new addition**?

```{r,echo=FALSE}
kable(recent_adds %>% 
        select(add_date,name,points,fullname) %>%
        arrange(-points))
```

Who should have been **left on the bench** this week--the lowest points scored by starters?

```{r,echo=FALSE}
kable(top_n(players %>% 
              filter(bench==0) %>%
              select(name,points,fullname),5,-points) %>%
        arrange(points))
```


Who won the **best scoring bench** award last week?

```{r,echo=FALSE}
kable(benchpoints %>% arrange(-points))
```

## Next week's games

Here's a quick summary of next week's matchups:

```{r,echo=FALSE}
kable(nextweek)
```

The closest matchup is {x}, and the biggest mismatch is {y}

Remember to check for bye weeks!